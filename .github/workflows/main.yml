name: Build and Test

on:
  push:
    branches:
      - master # tagged latest
      - 'release/**' # release branches
      - 'hotfix/**' # hotfix branches
      - 'dev-publish/**' # development branches that publish packages
    tags:
      - v* # semver release
  pull_request: # runs tests only for PRs to master
    branches:
      - master
  workflow_dispatch: {}

env:
  NAME: kth-mono
  CONAN_REMOTE: kth
  CONAN_REMOTE_URL: https://packages.kth.cash/api/
  # Static analysis flags
  SKIP_CLANG_FORMAT: true  # Set to false to enable clang-format checks

jobs:
  debug:
    runs-on: ubuntu-latest
    outputs:
      permitted: ${{ steps.check.outputs.permitted }}
    steps:
      - name: Debug Check Job
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Condition result: ${{ github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/master' }}"

  check:
    if: github.event_name == 'push' || 
      (github.event_name == 'pull_request' && 
       !startsWith(github.head_ref, 'release/') && 
       !startsWith(github.head_ref, 'hotfix/') &&
       !startsWith(github.head_ref, 'docs/') &&
       !startsWith(github.head_ref, 'style/') &&
       !startsWith(github.head_ref, 'chore/') &&
       !startsWith(github.head_ref, 'noci/'))
    runs-on: ubuntu-latest
    outputs:
      permitted: ${{ steps.check.outputs.permitted }}
    steps:
      - name: Debug Check Job
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Condition result: ${{ github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/heads/dev-publish') }}"
      - id: check
        continue-on-error: true
        uses: prince-chrismc/check-actor-permissions-action@v2
        with:
          permission: write

  setup:
    if: github.event_name == 'push' || 
      (github.event_name == 'pull_request' && 
       !startsWith(github.head_ref, 'release/') && 
       !startsWith(github.head_ref, 'hotfix/') &&
       !startsWith(github.head_ref, 'docs/') &&
       !startsWith(github.head_ref, 'style/') &&
       !startsWith(github.head_ref, 'chore/') &&
       !startsWith(github.head_ref, 'noci/'))
    runs-on: ubuntu-latest
    outputs:
      build-version: ${{ steps.version.outputs.build-version }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags
      - id: version
        uses: ./ci_utils/.github/actions/determine-version
        with:
          github-ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          run-number: ${{ github.run_number }}

  # build-base-docker-image:
  #   name: Builds Alpine Docker image
  #   runs-on: ubuntu-latest
  #   outputs:
  #     # name: docker.pkg.github.com/${{ github.repository }}/alpine-image:${{ steps.version.outputs.version }}
  #     name: docker.pkg.github.com/k-nuth/kth/alpine-image:${{ steps.version.outputs.version }}
  #   env:
  #     # name: docker.pkg.github.com/${{ github.repository }}/alpine-image
  #     name: docker.pkg.github.com/k-nuth/kth/alpine-image
  #   steps:
  #     - uses: actions/checkout@v3
  #       with:
  #         submodules: true
  #     - id: version
  #       run: echo "version=${{ hashFiles('./ci_utils/Dockerfile.build') }}" >> $GITHUB_OUTPUT
  #     - uses: docker/login-action@v2
  #       with:
  #         registry: docker.pkg.github.com
  #         username: ${{ github.repository_owner }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #     - id: check
  #       name: check existence
  #       run: |
  #         docker pull ${{ env.name }}:${{ steps.version.outputs.version }} > /dev/null && echo "exists=true" >> $GITHUB_OUTPUT || echo "exists=false" >> $GITHUB_OUTPUT
  #     - if: ${{ steps.check.outputs.exists == 'false' }}
  #       run: docker build . --file ./ci_utils/Dockerfile.build --tag ${{ env.name }}:${{ steps.version.outputs.version }}
  #     - if: ${{ steps.check.outputs.exists == 'false' }}
  #       run: docker push ${{ env.name }}:${{ steps.version.outputs.version }}

  generate-matrix:
    if: github.event_name == 'push' || 
      (github.event_name == 'pull_request' && 
       !startsWith(github.head_ref, 'release/') && 
       !startsWith(github.head_ref, 'hotfix/') &&
       !startsWith(github.head_ref, 'docs/') &&
       !startsWith(github.head_ref, 'style/') &&
       !startsWith(github.head_ref, 'chore/') &&
       !startsWith(github.head_ref, 'noci/'))
    name: Generate Job Matrix
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Debug Info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "Base ref: ${{ github.base_ref }}"
      - uses: actions/checkout@v3
        with:
          submodules: true
      - name: Generate Job Matrix
        id: set-matrix
        run: |
          MATRIX=$(cat ./ci_utils/.github/matrix.json)
          echo "${MATRIX}"
          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT

  calc-deps-with-container:
    needs: [setup, generate-matrix]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    name: ${{ matrix.config.name }}
    uses: ./.github/workflows/calc-deps-with-container.yml
    with:
      if: ${{ matrix.config.compiler == 'GCC' }}
      os: ${{ matrix.config.os }}
      image: "kthnode/gcc${{ matrix.config.version }}${{ matrix.config.docker_suffix }}"
      conan-remote: "kth"
      build-version: ${{ needs.setup.outputs.build-version }}
    secrets:
      conan-user: ${{ secrets.CONAN_LOGIN_USERNAME }}
      conan-password: ${{ secrets.CONAN_3_PASSWORD }}

  calc-deps-without-container:
    needs: [setup, generate-matrix]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    name: ${{ matrix.config.name }}
    uses: ./.github/workflows/calc-deps-without-container.yml
    with:
      if: ${{ matrix.config.compiler != 'GCC' }}
      os: ${{ matrix.config.os }}
      conan-remote: "kth"
      build-version: ${{ needs.setup.outputs.build-version }}
    secrets:
      conan-user: ${{ secrets.CONAN_LOGIN_USERNAME }}
      conan-password: ${{ secrets.CONAN_3_PASSWORD }}

  build-deps-with-container:
    needs: [calc-deps-with-container]
    strategy:
      matrix: ${{ fromJson(needs.calc-deps-with-container.outputs.matrix) }}
    name: ${{ matrix.config.name }}
    uses: ./.github/workflows/build-deps-with-container.yml
    with:
      if: ${{ matrix.config.compiler == 'GCC' }}
      os: ${{ matrix.config.os }}
      image: "kthnode/gcc${{ matrix.config.version }}${{ matrix.config.docker_suffix }}"
      reference: ${{ matrix.config.reference }}
      conan-remote: "kth"
    secrets:
      conan-user: ${{ secrets.CONAN_LOGIN_USERNAME }}
      conan-password: ${{ secrets.CONAN_3_PASSWORD }}

  build-deps-without-container:
    needs: [calc-deps-without-container]
    strategy:
      matrix: ${{ fromJson(needs.calc-deps-without-container.outputs.matrix) }}
    name: ${{ matrix.config.name }}
    uses: ./.github/workflows/build-deps-without-container.yml
    with:
      if: ${{ matrix.config.compiler != 'GCC' }}
      os: ${{ matrix.config.os }}
      reference: ${{ matrix.config.reference }}
      conan-remote: "kth"
    secrets:
      conan-user: ${{ secrets.CONAN_LOGIN_USERNAME }}
      conan-password: ${{ secrets.CONAN_3_PASSWORD }}

  build-with-container:
    needs: [setup, generate-matrix]
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
    name: ${{ matrix.config.name }}
    uses: ./.github/workflows/build-with-container.yml
    with:
      if: ${{ matrix.config.compiler == 'GCC' }}
      upload: ${{ (github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/release') || startsWith(github.ref, 'refs/heads/hotfix') || startsWith(github.ref, 'refs/heads/dev-publish'))) || (github.event_name == 'pull_request' && (startsWith(github.head_ref, 'release/') || startsWith(github.head_ref, 'hotfix/') || startsWith(github.head_ref, 'dev-publish/'))) }}
      os: ${{ matrix.config.os }}
      image: "kthnode/gcc${{ matrix.config.version }}${{ matrix.config.docker_suffix }}"
      conan-remote: "kth"
      recipe-name: "kth"
      compiler: ${{ matrix.config.compiler }}
      compiler-version: ${{ matrix.config.version }}
      build-version: "${{ needs.setup.outputs.build-version }}"

    secrets:
      CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_LOGIN_USERNAME }}
      CONAN_PASSWORD: ${{ secrets.CONAN_3_PASSWORD }}

  build-without-container:
    needs: [setup, generate-matrix]
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
    name: ${{ matrix.config.name }}
    uses: ./.github/workflows/build-without-container.yml
    with:
      if: ${{ matrix.config.compiler != 'GCC' }}
      upload: ${{ (github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/release') || startsWith(github.ref, 'refs/heads/hotfix') || startsWith(github.ref, 'refs/heads/dev-publish'))) || (github.event_name == 'pull_request' && (startsWith(github.head_ref, 'release/') || startsWith(github.head_ref, 'hotfix/') || startsWith(github.head_ref, 'dev-publish/'))) }}
      os: ${{ matrix.config.os }}
      conan-remote: "kth"
      recipe-name: "kth"
      compiler: ${{ matrix.config.compiler }}
      compiler-version: ${{ matrix.config.version }}
      build-version: "${{ needs.setup.outputs.build-version }}"
    secrets:
      CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_LOGIN_USERNAME }}
      CONAN_PASSWORD: ${{ secrets.CONAN_3_PASSWORD }}

  static-checks:
    name: Static Checks
    if: github.event_name == 'push' || 
      (github.event_name == 'pull_request' && 
       !startsWith(github.head_ref, 'release/') && 
       !startsWith(github.head_ref, 'hotfix/') &&
       !startsWith(github.head_ref, 'docs/') &&
       !startsWith(github.head_ref, 'style/') &&
       !startsWith(github.head_ref, 'chore/') &&
       !startsWith(github.head_ref, 'noci/'))

    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install clang-format
        if: env.SKIP_CLANG_FORMAT != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-15
          clang-format-15 --version

      - name: Clang-format check disabled
        if: env.SKIP_CLANG_FORMAT == 'true'
        run: |
          echo "⚠️ Clang-format check is currently disabled"
          echo "Set SKIP_CLANG_FORMAT=false in workflow env to enable"

      - name: Check code formatting
        if: env.SKIP_CLANG_FORMAT != 'true'
        shell: bash
        run: |
          echo "Checking C++ code formatting with clang-format..."
          
          # Find all C++ source files, avoiding broken pipe by using process substitution
          find . \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "*.c" \) \
            -not -path "./build/*" \
            -not -path "./cmake-build-*" \
            -not -path "./.conan/*" \
            -not -path "./third_party/*" \
            -not -path "./ci_utils/*" > cpp_files_all.txt
          
          # Take first 50 files to avoid overwhelming the CI
          head -50 cpp_files_all.txt > cpp_files.txt
          
          total_files=$(wc -l < cpp_files_all.txt)
          check_files=$(wc -l < cpp_files.txt)
          echo "Found $total_files C++ files total, checking first $check_files files"
          
          # Check formatting and collect results
          format_issues=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              if ! clang-format-15 --dry-run --Werror "$file" 2>/dev/null; then
                echo "❌ Formatting issues in: $file"
                echo "--- Expected format diff:"
                clang-format-15 "$file" | diff -u "$file" - || true
                echo ""
                format_issues=$((format_issues + 1))
              else
                echo "✅ $file"
              fi
            fi
          done < cpp_files.txt
          
          # Cleanup
          rm -f cpp_files_all.txt cpp_files.txt
          
          if [ $format_issues -gt 0 ]; then
            echo ""
            echo "❌ Found $format_issues files with formatting issues"
            echo "To fix, run: clang-format-15 -i <file>"
            exit 1
          else
            echo ""
            echo "✅ All checked files are properly formatted!"
          fi

