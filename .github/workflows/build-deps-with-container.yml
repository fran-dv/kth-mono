on:
  workflow_call:
    inputs:
      if:
        description: 'Whether to run this job'
        required: false
        type: boolean
      os:
        required: true
        type: string
      image:
        required: true
        type: string
      reference:
        required: true
        type: string
      context:
        required: false
        type: string
        default: 'host'
      conan-remote:
        required: true
        type: string
    secrets:
      conan-user:
        required: true
      conan-password:
        required: true
jobs:
  reusable-build-deps-with-container:
    if: ${{ inputs.if }}
    runs-on: ${{ inputs.os }}
    container:
      image: ${{ inputs.image }}
    steps:
      - name: ğŸ› Debug inputs
        run: |
          echo "inputs.conan-remote: ${{ inputs.conan-remote }}"
          echo "CONAN_REMOTE: $CONAN_REMOTE"
          echo "inputs.if: ${{ inputs.if }}"
          echo "inputs.os: ${{ inputs.os }}"
          echo "inputs.image: ${{ inputs.image }}"
          echo "inputs.reference: ${{ inputs.reference }}"


      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      # - if: ${{ inputs.reference != 'null' && inputs.compiler != 'GCC' }}
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: '3.11'
      - name: ğŸ”§ Setup Conan
        if: ${{ inputs.reference != 'null' }}
        uses: ./ci_utils/.github/actions/setup-conan
      - name: ğŸ”§ Setup kthbuild
        if: ${{ inputs.reference != 'null' }}
        uses: ./ci_utils/.github/actions/setup-kthbuild
      - name: ğŸ” Conan login
        if: ${{ inputs.reference != 'null' }}
        run: conan remote login -p ${{ secrets.conan-password }} ${{ inputs.conan-remote }} ${{ secrets.conan-user }}
      - name: ğŸ“¥ Download artifact
        if: ${{ inputs.reference != 'null' }}
        uses: actions/download-artifact@v4
        with:
          name: conan-lockfile-container
      - name: ğŸ—ï¸ Build dependencies
        if: ${{ inputs.reference != 'null' }}
        run: |
          if [ "${{ inputs.context }}" = "build" ]; then
            echo "Building tool requirement: ${{ inputs.reference }}"
            conan install --tool-requires=${{ inputs.reference }} -l conan.lock -b missing -pr:b linux-ci-cd -pr:h linux-ci-cd
          else
            echo "Building host requirement: ${{ inputs.reference }}"
            conan install --requires=${{ inputs.reference }} -l conan.lock -b missing -pr:b linux-ci-cd -pr:h linux-ci-cd
          fi
      - name: ğŸ“¦ Upload package
        if: ${{ inputs.reference != 'null' }}
        run: conan upload ${{ inputs.reference }} -r ${{ inputs.conan-remote }} # --all
      - run: exit 0
