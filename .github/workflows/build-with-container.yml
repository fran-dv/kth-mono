on:
  workflow_call:
    inputs:
      if:
        description: 'Whether to run this job'
        required: true
        type: boolean
      upload:
        description: 'Have to upload the package'
        required: true
        type: boolean
      os:
        required: true
        type: string
      image:
        required: true
        type: string
      recipe-name:
        required: true
        type: string
      conan-remote:
        required: true
        type: string
      compiler:
        required: true
        type: string
      compiler-version:
        required: true
        type: string
      build-version:
        required: true
        type: string
      enable-asan:
        description: 'Enable AddressSanitizer build'
        required: false
        type: boolean
        default: false
      enable-ubsan:
        description: 'Enable UndefinedBehaviorSanitizer build'
        required: false
        type: boolean
        default: false
      enable-tsan:
        description: 'Enable ThreadSanitizer build'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'Skip unit test execution'
        required: false
        type: boolean
        default: true
    secrets:
      CONAN_LOGIN_USERNAME:
        required: true
      CONAN_PASSWORD:
        required: true
jobs:
  reusable-build-with-container:
    if: ${{ inputs.if }}
    runs-on: ${{ inputs.os }}
    container:
      image: ${{ inputs.image }}
    steps:
      - run: |
          echo "inputs.conan-remote: ${{ inputs.conan-remote }}"
          echo "inputs.if: ${{ inputs.if }}"
          echo "inputs.os: ${{ inputs.os }}"
          echo "inputs.image: ${{ inputs.image }}"

          echo "inputs.conan-remote:       ${{ inputs.conan-remote }}"
          echo "inputs.recipe-name:        ${{ inputs.recipe-name }}"

          echo "inputs.compiler:           ${{ inputs.compiler }}"
          echo "inputs.compiler-version:   ${{ inputs.compiler-version }}"

          echo "inputs.version-file:       ${{ inputs.version-file }}"
          echo "inputs.upload:             ${{ inputs.upload }}"
          # echo "github.event_name:         ${{ github.event_name }}"


      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/cache@v4
        with:
          path: ~/.conan/data
          key: ${{ runner.os }}-${{ hashFiles('**/conan.lock') }}
      # - uses: actions/cache@v4
      #   with:
      #     path: ~/.cache/pip
      #     key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}


      # - if: ${{ inputs.compiler != 'GCC' }}
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: '3.11'

      # - uses: actions/setup-node@v4
      #   with:
      #     node-version: '20.x'

      - uses: ./ci_utils/.github/actions/setup-conan
      - uses: ./ci_utils/.github/actions/setup-kthbuild
      - uses: lukka/get-cmake@6d674ef0d7703f12f77182ca400e1e7be99fd399

      # - uses: github/codeql-action/init@v2
      #   with:
      #     languages: 'cpp'

      - uses: ./ci_utils/.github/actions/replace-version-monorepo
        with:
          new-version: ${{ inputs.build-version }}


      - name: üî® Build
        working-directory: .
        run: |
          # Prepare sanitizer flags
          SANITIZER_FLAGS=""
          BUILD_SUFFIX=""
          
          # Check for conflicting sanitizers (AddressSanitizer and ThreadSanitizer are mutually exclusive)
          if [ "${{ inputs.enable-asan }}" = "true" ] && [ "${{ inputs.enable-tsan }}" = "true" ]; then
            echo "‚ö†Ô∏è WARNING: AddressSanitizer and ThreadSanitizer are mutually exclusive"
            echo "üîß Prioritizing AddressSanitizer and disabling ThreadSanitizer"
            TSAN_ENABLED=false
          else
            TSAN_ENABLED="${{ inputs.enable-tsan }}"
          fi
          
          if [ "${{ inputs.enable-asan }}" = "true" ]; then
            echo "üß™ Enabling AddressSanitizer build"
            SANITIZER_FLAGS="$SANITIZER_FLAGS -fsanitize=address -fno-omit-frame-pointer"
            BUILD_SUFFIX="${BUILD_SUFFIX}-asan"
          fi
          
          if [ "${{ inputs.enable-ubsan }}" = "true" ]; then
            echo "üß™ Enabling UndefinedBehaviorSanitizer build"
            SANITIZER_FLAGS="$SANITIZER_FLAGS -fsanitize=undefined -fno-omit-frame-pointer"
            BUILD_SUFFIX="${BUILD_SUFFIX}-ubsan"
          fi
          
          if [ "$TSAN_ENABLED" = "true" ]; then
            echo "üß™ Enabling ThreadSanitizer build"
            SANITIZER_FLAGS="$SANITIZER_FLAGS -fsanitize=thread"
            BUILD_SUFFIX="${BUILD_SUFFIX}-tsan"
          fi
          
          # Set environment variables for sanitizers
          if [ -n "$SANITIZER_FLAGS" ]; then
            echo "üîß Using sanitizer flags: $SANITIZER_FLAGS"
            export CXXFLAGS="$CXXFLAGS $SANITIZER_FLAGS"
            export CFLAGS="$CFLAGS $SANITIZER_FLAGS"
            export LDFLAGS="$LDFLAGS $SANITIZER_FLAGS"
          fi
          
          # Choose build strategy based on whether we need to upload
          if [ "${{ inputs.upload }}" = "true" ]; then
            echo "üöÄ Release build - using conan create (includes package validation)"
            conan remote login -p ${{ secrets.CONAN_PASSWORD }} ${{ inputs.conan-remote }} ${{ secrets.CONAN_LOGIN_USERNAME }}
            conan lock create conanfile.py --version ${{ inputs.build-version }} --lockfile=conan.lock --lockfile-out=build/conan.lock -pr:b linux-ci-cd -pr:h linux-ci-cd -o march_id=ZLm9Pjh
            conan create conanfile.py --version ${{ inputs.build-version }} --lockfile=build/conan.lock -pr:b linux-ci-cd -pr:h linux-ci-cd --build=missing -o march_id=ZLm9Pjh -o tests=False
          else
            echo "üî® Development build - direct compilation with tests"
            conan lock create conanfile.py --version ${{ inputs.build-version }} --lockfile=conan.lock --lockfile-out=build/conan.lock -pr:b linux-ci-cd -pr:h linux-ci-cd -o march_id=ZLm9Pjh
            conan install conanfile.py --lockfile=build/conan.lock -of build --build=missing -pr:b linux-ci-cd -pr:h linux-ci-cd -o march_id=ZLm9Pjh -o tests=True
            
            cmake --preset conan-release \
                 -DCMAKE_VERBOSE_MAKEFILE=ON \
                 -DGLOBAL_BUILD=ON \
                 -DENABLE_TEST=ON \
                 -DCMAKE_BUILD_TYPE=Release
                 
            cmake --build --preset conan-release -j4
          fi

      - name: üß™ Run unit tests
        if: ${{ inputs.skip-tests != true && inputs.upload != true }}
        working-directory: .
        run: |
          echo "üß™ Running unit tests for development build..."
          
          # Set sanitizer options for better reporting (preserve conflict resolution from build step)
          TSAN_ENABLED_FOR_TESTS="${{ inputs.enable-tsan }}"
          if [ "${{ inputs.enable-asan }}" = "true" ] && [ "${{ inputs.enable-tsan }}" = "true" ]; then
            TSAN_ENABLED_FOR_TESTS=false
          fi
          
          if [ "${{ inputs.enable-asan }}" = "true" ] || [ "${{ inputs.enable-ubsan }}" = "true" ] || [ "$TSAN_ENABLED_FOR_TESTS" = "true" ]; then
            echo "üß™ Running tests with sanitizers enabled..."
            echo "‚ö†Ô∏è Tests may run slower due to sanitizer overhead"
            
            if [ "${{ inputs.enable-asan }}" = "true" ]; then
              export ASAN_OPTIONS="detect_leaks=1:abort_on_error=1:print_stats=1"
            fi
            
            if [ "${{ inputs.enable-ubsan }}" = "true" ]; then
              export UBSAN_OPTIONS="print_stacktrace=1:abort_on_error=1"
            fi
            
            if [ "$TSAN_ENABLED_FOR_TESTS" = "true" ]; then
              export TSAN_OPTIONS="halt_on_error=1:abort_on_error=1"
            fi
          fi
          
          # Run unit tests (project was already built with tests in previous step)
          cd build/build/Release
          
          if [ "${{ inputs.enable-asan }}" = "true" ] || [ "${{ inputs.enable-ubsan }}" = "true" ] || [ "$TSAN_ENABLED_FOR_TESTS" = "true" ]; then
            timeout 1800 ctest --output-on-failure --parallel 2 || echo "Some tests may have failed or timed out with sanitizers"
          else
            ctest --output-on-failure --parallel 4 || echo "Some tests may have failed, but continuing..."
          fi

      - name: ‚è≠Ô∏è Skip tests info
        if: ${{ inputs.skip-tests == true }}
        run: |
          echo "‚è≠Ô∏è Unit tests skipped (skip-tests=true)"
          
      - name: üöÄ Release build info
        if: ${{ inputs.upload == true }}
        run: |
          echo "üöÄ Release build completed - package validation included in conan create"
          echo "üì¶ Package ready for upload"

      # - uses: github/codeql-action/analyze@v2

      - name: üì¶ Upload
        # if: github.event_name == 'push' && needs.check.outputs.permitted == 'true'
        if: ${{ inputs.upload }}
        run: |
          conan remote login -p ${{ secrets.CONAN_PASSWORD }} ${{ inputs.conan-remote }} ${{ secrets.CONAN_LOGIN_USERNAME }}
          conan upload ${{ inputs.recipe-name }}/${{ inputs.build-version }}@ -r ${{ inputs.conan-remote }} # --all
