on:
  workflow_call:
    inputs:
      if:
        description: 'Whether to run this job'
        required: true
        type: boolean
      upload:
        description: 'Have to upload the package'
        required: true
        type: boolean
      os:
        required: true
        type: string
      recipe-name:
        required: true
        type: string
      conan-remote:
        required: true
        type: string
      compiler:
        required: true
        type: string
      compiler-version:
        required: true
        type: string
      build-version:
        required: true
        type: string
      enable-asan:
        description: 'Enable AddressSanitizer build'
        required: false
        type: boolean
        default: false
      enable-ubsan:
        description: 'Enable UndefinedBehaviorSanitizer build'
        required: false
        type: boolean
        default: false
      enable-tsan:
        description: 'Enable ThreadSanitizer build'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'Skip unit test execution'
        required: false
        type: boolean
        default: true
    secrets:
      CONAN_LOGIN_USERNAME:
        required: true
      CONAN_PASSWORD:
        required: true
jobs:
  reusable-build-without-container:
    if: ${{ inputs.if }}
    runs-on: ${{ inputs.os }}
    steps:
      - name: ğŸ› Debug inputs
        run: |
          echo "inputs.conan-remote: ${{ inputs.conan-remote }}"
          echo "inputs.if: ${{ inputs.if }}"
          echo "inputs.os: ${{ inputs.os }}"

          echo "inputs.conan-remote:       ${{ inputs.conan-remote }}"
          echo "inputs.recipe-name:        ${{ inputs.recipe-name }}"

          echo "inputs.compiler:           ${{ inputs.compiler }}"
          echo "inputs.compiler-version:   ${{ inputs.compiler-version }}"

          echo "inputs.version-file:       ${{ inputs.version-file }}"
          echo "inputs.upload:             ${{ inputs.upload }}"
          # echo "github.event_name:         ${{ github.event_name }}"

      # ----------------------------------------------------------------

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ’¾ Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan/data
          key: ${{ runner.os }}-${{ hashFiles('**/conan.lock') }}
      # - uses: actions/cache@v4
      #   with:
      #     path: ~/.cache/pip
      #     key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}


      # - if: ${{ inputs.compiler != 'GCC' }}
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ”§ Setup Conan
        uses: ./ci_utils/.github/actions/setup-conan
      - name: ğŸ”§ Setup kthbuild
        uses: ./ci_utils/.github/actions/setup-kthbuild
      - name: ğŸ”§ Get CMake
        uses: lukka/get-cmake@latest

      # - uses: github/codeql-action/init@v2
      #   with:
      #     languages: 'cpp'

      - name: ğŸ”§ Replace version
        uses: ./ci_utils/.github/actions/replace-version-monorepo
        with:
          new-version: ${{ inputs.build-version }}


      - name: ğŸ”¨ Build
        working-directory: .
        run: |
          # Prepare sanitizer flags
          SANITIZER_FLAGS=""
          BUILD_SUFFIX=""
          
          # Check for conflicting sanitizers (AddressSanitizer and ThreadSanitizer are mutually exclusive)
          if [ "${{ inputs.enable-asan }}" = "true" ] && [ "${{ inputs.enable-tsan }}" = "true" ]; then
            echo "âš ï¸ WARNING: AddressSanitizer and ThreadSanitizer are mutually exclusive"
            echo "ğŸ”§ Prioritizing AddressSanitizer and disabling ThreadSanitizer"
            TSAN_ENABLED=false
          else
            TSAN_ENABLED="${{ inputs.enable-tsan }}"
          fi
          
          if [ "${{ inputs.enable-asan }}" = "true" ]; then
            echo "ğŸ§ª Enabling AddressSanitizer build"
            SANITIZER_FLAGS="$SANITIZER_FLAGS -fsanitize=address -fno-omit-frame-pointer"
            BUILD_SUFFIX="${BUILD_SUFFIX}-asan"
          fi
          
          if [ "${{ inputs.enable-ubsan }}" = "true" ]; then
            echo "ğŸ§ª Enabling UndefinedBehaviorSanitizer build"
            SANITIZER_FLAGS="$SANITIZER_FLAGS -fsanitize=undefined -fno-omit-frame-pointer"
            BUILD_SUFFIX="${BUILD_SUFFIX}-ubsan"
          fi
          
          if [ "$TSAN_ENABLED" = "true" ]; then
            echo "ğŸ§ª Enabling ThreadSanitizer build"
            SANITIZER_FLAGS="$SANITIZER_FLAGS -fsanitize=thread"
            BUILD_SUFFIX="${BUILD_SUFFIX}-tsan"
          fi
          
          # Set environment variables for sanitizers
          if [ -n "$SANITIZER_FLAGS" ]; then
            echo "ğŸ”§ Using sanitizer flags: $SANITIZER_FLAGS"
            export CXXFLAGS="$CXXFLAGS $SANITIZER_FLAGS"
            export CFLAGS="$CFLAGS $SANITIZER_FLAGS"
            export LDFLAGS="$LDFLAGS $SANITIZER_FLAGS"
          fi
          
          # Choose build strategy based on whether we need to upload
          if [ "${{ inputs.upload }}" = "true" ]; then
            echo "ğŸš€ Release build - using conan create (includes package validation)"
            conan remote login -p ${{ secrets.CONAN_PASSWORD }} ${{ inputs.conan-remote }} ${{ secrets.CONAN_LOGIN_USERNAME }}
            conan lock create conanfile.py --version ${{ inputs.build-version }} --lockfile=conan.lock --lockfile-out=build/conan.lock -pr:b general-ci-cd -pr:h general-ci-cd
            conan create conanfile.py --version ${{ inputs.build-version }} --lockfile=build/conan.lock -pr:b general-ci-cd -pr:h general-ci-cd --build=missing -o tests=False
          else
            echo "ğŸ”¨ Development build - direct compilation with tests"
            conan lock create conanfile.py --version ${{ inputs.build-version }} --lockfile=conan.lock --lockfile-out=build/conan.lock -pr:b general-ci-cd -pr:h general-ci-cd
            conan install conanfile.py --lockfile=build/conan.lock -of build --build=missing -pr:b general-ci-cd -pr:h general-ci-cd -o tests=True
            
            cmake --preset conan-release \
                 -DCMAKE_VERBOSE_MAKEFILE=ON \
                 -DGLOBAL_BUILD=ON \
                 -DENABLE_TEST=ON \
                 -DCMAKE_BUILD_TYPE=Release
                 
            cmake --build --preset conan-release -j4
          fi

      - name: ğŸ“Š Build summary
        if: always()
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.build-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ inputs.os }}" >> $GITHUB_STEP_SUMMARY
          echo "**Compiler:** ${{ inputs.compiler }} ${{ inputs.compiler-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build type
          if [ "${{ inputs.upload }}" = "true" ]; then
            echo "**Build Type:** Release build (with package validation)" >> $GITHUB_STEP_SUMMARY
            echo "**Uploaded to Conan:** Yes" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Build Type:** Development build (with tests)" >> $GITHUB_STEP_SUMMARY
            echo "**Uploaded to Conan:** No" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Sanitizers
          SANITIZERS_ENABLED=false
          echo "**Sanitizers:**" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.enable-asan }}" = "true" ]; then
            echo "- AddressSanitizer (ASan): Enabled" >> $GITHUB_STEP_SUMMARY
            SANITIZERS_ENABLED=true
          fi
          if [ "${{ inputs.enable-ubsan }}" = "true" ]; then
            echo "- UndefinedBehaviorSanitizer (UBSan): Enabled" >> $GITHUB_STEP_SUMMARY
            SANITIZERS_ENABLED=true
          fi
          if [ "${{ inputs.enable-tsan }}" = "true" ]; then
            if [ "${{ inputs.enable-asan }}" = "true" ]; then
              echo "- ThreadSanitizer (TSan): Disabled (conflicts with ASan)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ThreadSanitizer (TSan): Enabled" >> $GITHUB_STEP_SUMMARY
              SANITIZERS_ENABLED=true
            fi
          fi
          if [ "$SANITIZERS_ENABLED" = "false" ]; then
            echo "- None enabled" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ§ª Run unit tests
        if: ${{ inputs.skip-tests != true && inputs.upload != true }}
        working-directory: .
        run: |
          echo "ğŸ§ª Running unit tests for development build..."
          
          # Set sanitizer options for better reporting (preserve conflict resolution from build step)
          TSAN_ENABLED_FOR_TESTS="${{ inputs.enable-tsan }}"
          if [ "${{ inputs.enable-asan }}" = "true" ] && [ "${{ inputs.enable-tsan }}" = "true" ]; then
            TSAN_ENABLED_FOR_TESTS=false
          fi
          
          if [ "${{ inputs.enable-asan }}" = "true" ] || [ "${{ inputs.enable-ubsan }}" = "true" ] || [ "$TSAN_ENABLED_FOR_TESTS" = "true" ]; then
            echo "ğŸ§ª Running tests with sanitizers enabled..."
            echo "âš ï¸ Tests may run slower due to sanitizer overhead"
            
            if [ "${{ inputs.enable-asan }}" = "true" ]; then
              export ASAN_OPTIONS="detect_leaks=1:abort_on_error=1:print_stats=1"
            fi
            
            if [ "${{ inputs.enable-ubsan }}" = "true" ]; then
              export UBSAN_OPTIONS="print_stacktrace=1:abort_on_error=1"
            fi
            
            if [ "$TSAN_ENABLED_FOR_TESTS" = "true" ]; then
              export TSAN_OPTIONS="halt_on_error=1:abort_on_error=1"
            fi
          fi
          
          # Run unit tests (project was already built with tests in previous step)
          cd build/build/Release
          
          if [ "${{ inputs.enable-asan }}" = "true" ] || [ "${{ inputs.enable-ubsan }}" = "true" ] || [ "$TSAN_ENABLED_FOR_TESTS" = "true" ]; then
            timeout 1800 ctest --output-on-failure --parallel 2 || echo "Some tests may have failed or timed out with sanitizers"
          else
            ctest --output-on-failure --parallel 4 || echo "Some tests may have failed, but continuing..."
          fi

      - name: â­ï¸ Skip tests info
        if: ${{ inputs.skip-tests == true }}
        run: |
          echo "â­ï¸ Unit tests skipped (skip-tests=true)"
          
      - name: ğŸš€ Release build info
        if: ${{ inputs.upload == true }}
        run: |
          echo "ğŸš€ Release build completed - package validation included in conan create"
          echo "ğŸ“¦ Package ready for upload"

      # - uses: github/codeql-action/analyze@v2

      - name: ğŸ“¦ Upload
        # if: github.event_name == 'push' && needs.check.outputs.permitted == 'true'
        if: ${{ inputs.upload }}
        run: |
          conan remote login -p ${{ secrets.CONAN_PASSWORD }} ${{ inputs.conan-remote }} ${{ secrets.CONAN_LOGIN_USERNAME }}
          conan upload ${{ inputs.recipe-name }}/${{ inputs.build-version }}@ -r ${{ inputs.conan-remote }} # --all
